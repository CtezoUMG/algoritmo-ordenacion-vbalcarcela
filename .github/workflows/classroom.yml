name: Autograding Tests
on:
  - push
  - workflow_dispatch
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Pre-compilar Release
      run: dotnet build -c Release

    # --- EJECUCI√ìN DE PRUEBA DE ORDENAMIENTO ---
    - name: Prueba Bubble Sort 10K
      id: bubble-sort
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "Bubble Sort 10,000"
        # Importante: El ejecutable debe llamarse igual que tu proyecto
        command: "/usr/bin/time -v ./bin/Release/net10.0/AlgoOrder > out.txt 2> met.txt && cat out.txt"
        input: ""
        expected-output: "VALIDATION: SUCCESS"
        comparison-method: contains
        timeout: 15
        max-score: 100

    # --- REPORTE Y ENV√çO UNIFICADO ---
    - name: üìä REPORTE DE EFICIENCIA Y ENV√çO A TABLERO
      if: always()
      run: |
        echo "==============================================================="
        echo "    AUDITOR√çA T√âCNICA DE ALGORITMOS - BUBBLE SORT UMG"
        echo "==============================================================="
        
        # Asegurar que los archivos existan
        touch met.txt out.txt

        # 1. Extraer valores del √∫nico caso
        T1=$(grep "User time" met.txt | cut -d: -f2 | xargs || echo "0")
        R1=$(grep "Maximum resident set size" met.txt | cut -d: -f2 | xargs || echo "0")
        C1=$(grep "Percent of CPU" met.txt | cut -d: -f2 | tr -d '%' | xargs || echo "0")
        
        # 2. Calcular Punteo Acad√©mico (100 si pas√≥, 0 si fall√≥)
        PUNTEO=0
        if [[ "${{ steps.bubble-sort.outcome }}" == "success" ]]; then PUNTEO=100; fi

        # 3. Calcular Score Ol√≠mpico (Usando los valores de la √∫nica prueba)
        # Como no hay promedios, usamos T1, R1 y C1 directamente
        SCORE=$(awk -v t="$T1" -v r="$R1" -v c="$C1" \
          'BEGIN { printf "%.2f", (t * 1000 * 1.0) + ((r / 1024) * 0.5) + (c * 0.2) }')

        echo "üöÄ INTENTO N√öMERO: ${{ github.run_number }}"
        echo "---------------------------------------------------------------"
        echo "ORDENAMIENTO: [OUT: $(cat out.txt | head -n 1)]"
        echo "TIEMPO: ${T1}s | RAM: ${R1}KB | CPU: ${C1}%"
        echo "---------------------------------------------------------------"
        
        echo ""
        echo "üèÜ PUNTEO: $PUNTEO / 100"
        echo "üèÜ SCORE FINAL PARA EL RANKING: $SCORE"

        # ENV√çO A GOOGLE SHEETS (Incluyendo la columna 'punteo')
        curl -L -X POST "https://script.google.com/macros/s/AKfycbwgKABgEL8GnF8fUkccLz8e34anoIUE9uzonIM75Rk01fcbvrJdlo7JsSemRUNYBkVN/exec" \
             -H "Content-Type: application/json" \
             -d "{
                  \"fecha\": \"$(date -u -d '-6 hours' +'%d/%m/%Y %H:%M')\",
                  \"usuario\": \"${{ github.actor }}\",
                  \"intento\": ${{ github.run_number }},
                  \"score\": \"$SCORE\",
                  \"tiempo_avg\": \"${T1}s\",
                  \"ram_avg\": \"${R1}KB\",
                  \"cpu_avg\": \"${C1}%\",
                  \"punteo\": \"$PUNTEO\"
                }"

    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      if: always()
      env:
        BUBBLE-SORT_RESULTS: "${{ steps.bubble-sort.outputs.result }}"
      with:
        runners: bubble-sort